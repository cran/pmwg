<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Introduction to pmwg</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to pmwg</h1>



<p>pmwg is a package that implements an efficient and flexible Particle Metropolis within Gibbs sampler as outlined in the paper <span class="citation">(Gunawan et al. 2020)</span>. The sampler estimates group level parameter values, the covariance matrix related parameter estimates to each other and the individual level parameter estimates (random effects) in a two step process. The process consists of a Gibbs sampling step for group level/covariate estimates followed by a particle metropolis step for random effects for each iteration of the sampler.</p>
<p>The sampling proceeds through three stages, burn in, adaptation and a final sampling stage. Burn in can be relatively short and should move the sample estimates from the start values to a plausible region of the parameter space relatively quickly. The adaptation stage is the same as burn in, however samples from this stage are used to generate a proposal distribution used to create samples more efficiently for the final sampling stage.</p>
<div id="the-data" class="section level2">
<h2>The data</h2>
<p>First we will load the pmwg package and explore the included dataset</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(pmwg)</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">head</span>(forstmann)</a></code></pre></div>
<pre><code>##      subject condition stim resp     rt
## 1115       1         1    2    2 0.4319
## 1116       1         3    2    2 0.5015
## 1117       1         3    1    1 0.3104
## 1118       1         1    2    2 0.4809
## 1119       1         1    1    1 0.3415
## 1120       1         2    1    1 0.3465</code></pre>
<p>The forstmann dataset is from <span class="citation">(Forstmann et al. 2008)</span> and is the cleaned data from an experiment that displayed a random dot motion task with one of three speed accuracy manipulations (respond accurately instructions, neutral instructions and respond quickly instructions).</p>
<p>We can see that there are 5 columns:</p>
<ul>
<li><code>subject</code> - which gives an ID for each of the 19 participants</li>
<li><code>condition</code> - the speed accuracy instructions for the trial</li>
<li><code>stim</code> - whether dots were moving left or right</li>
<li><code>resp</code> - whether the participant responded left or right</li>
<li><code>rt</code> - the response time for the trial</li>
</ul>
<p>We will use the <code>rtdists</code> package to look at threshold differences between the three conditions to see whether there is evidence for different thresholds (the evidence required to trigger a response) in each of the three conditions. For a full explanation of the model please see the <a href="https://university-of-newcastle-research.github.io/samplerDoc/">full documentation</a> in Chapter 3.</p>
</div>
<div id="the-log-likelihood-function" class="section level2">
<h2>The log-likelihood function</h2>
<p>Now that we have the data we will need to specify the log-likelihood function.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">lba_loglike &lt;-<span class="st"> </span><span class="cf">function</span>(x, data) {</a>
<a class="sourceLine" id="cb3-2" title="2">  x &lt;-<span class="st"> </span><span class="kw">exp</span>(x)</a>
<a class="sourceLine" id="cb3-3" title="3">  <span class="cf">if</span> (<span class="kw">any</span>(data<span class="op">$</span>rt <span class="op">&lt;</span><span class="st"> </span>x[<span class="st">&quot;t0&quot;</span>])) {</a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="kw">return</span>(<span class="op">-</span><span class="fl">1e10</span>)</a>
<a class="sourceLine" id="cb3-5" title="5">  }</a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="co"># This is faster than &quot;paste&quot;.</span></a>
<a class="sourceLine" id="cb3-7" title="7">  bs &lt;-<span class="st"> </span>x[<span class="st">&quot;A&quot;</span>] <span class="op">+</span><span class="st"> </span>x[<span class="kw">c</span>(<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;b2&quot;</span>, <span class="st">&quot;b3&quot;</span>)][data<span class="op">$</span>condition]</a>
<a class="sourceLine" id="cb3-8" title="8"></a>
<a class="sourceLine" id="cb3-9" title="9">  out &lt;-<span class="st"> </span>rtdists<span class="op">::</span><span class="kw">dLBA</span>(</a>
<a class="sourceLine" id="cb3-10" title="10">    <span class="dt">rt =</span> data<span class="op">$</span>rt, <span class="co"># nolint</span></a>
<a class="sourceLine" id="cb3-11" title="11">    <span class="dt">response =</span> data<span class="op">$</span>stim,</a>
<a class="sourceLine" id="cb3-12" title="12">    <span class="dt">A =</span> x[<span class="st">&quot;A&quot;</span>],</a>
<a class="sourceLine" id="cb3-13" title="13">    <span class="dt">b =</span> bs,</a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="dt">t0 =</span> x[<span class="st">&quot;t0&quot;</span>],</a>
<a class="sourceLine" id="cb3-15" title="15">    <span class="dt">mean_v =</span> x[<span class="kw">c</span>(<span class="st">&quot;v1&quot;</span>, <span class="st">&quot;v2&quot;</span>)],</a>
<a class="sourceLine" id="cb3-16" title="16">    <span class="dt">sd_v =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb3-17" title="17">    <span class="dt">distribution =</span> <span class="st">&quot;norm&quot;</span>,</a>
<a class="sourceLine" id="cb3-18" title="18">    <span class="dt">silent =</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb3-19" title="19">  )</a>
<a class="sourceLine" id="cb3-20" title="20">  bad &lt;-<span class="st"> </span>(out <span class="op">&lt;</span><span class="st"> </span><span class="fl">1e-10</span>) <span class="op">|</span><span class="st"> </span>(<span class="op">!</span><span class="kw">is.finite</span>(out))</a>
<a class="sourceLine" id="cb3-21" title="21">  out[bad] &lt;-<span class="st"> </span><span class="fl">1e-10</span></a>
<a class="sourceLine" id="cb3-22" title="22">  out &lt;-<span class="st"> </span><span class="kw">sum</span>(<span class="kw">log</span>(out))</a>
<a class="sourceLine" id="cb3-23" title="23">  out</a>
<a class="sourceLine" id="cb3-24" title="24">}</a></code></pre></div>
<p>This function contains the primary implementation of our model for the data. The <code>pmwgs</code> object that we run later in this example will pass two things:</p>
<ul>
<li>A set of parameter values <code>x</code> that we will be assessing.</li>
<li>A subset of our dataset (<code>data</code>), the data for one subject.</li>
</ul>
<p>Our job then in the function is to take the parameter values and calculate the log-likelihood of the data given the parameter values.</p>
<p>The overall process is as follows:</p>
<ul>
<li>Take the exponent of the parameter values (that are stored in log-form</li>
<li>Test for improbable values of t0 (non-decision time) and return extremely low log-likelihood if they are unlikely.</li>
<li>Create a vector of b (threshold) parameter values for the call to rtdists</li>
<li>Use the rtdists <code>dLBA</code> function to calculate the likelihood of the data given our parameter estimates.</li>
<li>Clean extremely small of otherwise bad values from output vector.</li>
<li>Return the sum of the log of the likelihood of each row of the data.</li>
</ul>
</div>
<div id="other-necessary-components" class="section level2">
<h2>Other necessary components</h2>
<p>There are a couple of other necessary components to running the sampler, a list of parameters and a prior for the group level parameter values.</p>
<p>In this case the parameters consist of threshold parameters for each of the three conditions (<code>b1</code>, <code>b2</code> and <code>b3</code>), a upper limit on the range for accumulator start points (<code>A</code>), the drift rates for evidence accumulation for the two stimulus types (<code>v1</code> and <code>v2</code>) and non-decision time (<code>t0</code>).</p>
<p>The prior for this model is uninformed and is just 0 for the mean of the group parameters and standard deviation of 1 for each parameter.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">pars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;b1&quot;</span>, <span class="st">&quot;b2&quot;</span>, <span class="st">&quot;b3&quot;</span>, <span class="st">&quot;A&quot;</span>, <span class="st">&quot;v1&quot;</span>, <span class="st">&quot;v2&quot;</span>, <span class="st">&quot;t0&quot;</span>)</a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3">priors &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="dt">theta_mu_mean =</span> <span class="kw">rep</span>(<span class="dv">0</span>, <span class="kw">length</span>(pars)),</a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="dt">theta_mu_var =</span> <span class="kw">diag</span>(<span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(pars)))</a>
<a class="sourceLine" id="cb4-6" title="6">)</a></code></pre></div>
</div>
<div id="creating-and-running-the-sampler" class="section level2">
<h2>Creating and running the sampler</h2>
<p>Once we have these components we are ready to create and run the sampler.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># Create the Particle Metropolis within Gibbs sampler object</span></a>
<a class="sourceLine" id="cb5-2" title="2">sampler &lt;-<span class="st"> </span><span class="kw">pmwgs</span>(</a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="dt">data =</span> forstmann,</a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="dt">pars =</span> pars,</a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="dt">ll_func =</span> lba_loglike,</a>
<a class="sourceLine" id="cb5-6" title="6">  <span class="dt">prior =</span> priors</a>
<a class="sourceLine" id="cb5-7" title="7">)</a></code></pre></div>
<p>Creation of the sampler object is done through a call to the <code>pmwgs</code> function, which creates the object and sets numerous precomputed values based on the number of parameters and other aspects of the included function arguments. Next steps are to initialise the sampler with start values for the random effects and then run the three stages of sampling.</p>
<p>The stages can be long running, but once complete you will have</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># Initialise (generate first random effects for sampler)</span></a>
<a class="sourceLine" id="cb6-2" title="2">sampler &lt;-<span class="st"> </span><span class="kw">init</span>(sampler)  <span class="co"># Can also pass start points for sampler</span></a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="co"># Run each stage of the sampler, can adjust number of particles on each</span></a>
<a class="sourceLine" id="cb6-5" title="5">sampler &lt;-<span class="st"> </span><span class="kw">run_stage</span>(sampler, <span class="dt">stage =</span> <span class="st">&quot;burn&quot;</span>)</a>
<a class="sourceLine" id="cb6-6" title="6">sampler &lt;-<span class="st"> </span><span class="kw">run_stage</span>(sampler, <span class="dt">stage =</span> <span class="st">&quot;adapt&quot;</span>)</a>
<a class="sourceLine" id="cb6-7" title="7">sampler &lt;-<span class="st"> </span><span class="kw">run_stage</span>(sampler, <span class="dt">stage =</span> <span class="st">&quot;sample&quot;</span>)</a></code></pre></div>
<p>The <code>run_stage</code> command can also be passed other arguments such as <code>iter</code> for number of iterations, <code>particles</code> for number of particles among others and more. For a full list see <a href="https://university-of-newcastle-research.github.io/samplerDoc/pmwg-sampler-and-signal-detection-theory.html#run-sdtsampler">the description in the PMwG Tutorial Book</a>.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references">
<div id="ref-forstmann2008">
<p>Forstmann, Birte U., Gilles Dutilh, Scott Brown, Jane Neumann, D. Yves von Cramon, K. Richard Ridderinkhof, and Eric-Jan Wagenmakers. 2008. “Striatum and Pre-Sma Facilitate Decision-Making Under Time Pressure.” <em>Proceedings of the National Academy of Sciences</em> 105 (45): 17538–42. <a href="https://doi.org/10.1073/pnas.0805903105">https://doi.org/10.1073/pnas.0805903105</a>.</p>
</div>
<div id="ref-gunawan2020">
<p>Gunawan, D., G.E. Hawkins, M.-N. Tran, R. Kohn, and S.D. Brown. 2020. “New Estimation Approaches for the Hierarchical Linear Ballistic Accumulator Model.” <em>Journal of Mathematical Psychology</em> 96: 102368. <a href="https://doi.org/https://doi.org/10.1016/j.jmp.2020.102368">https://doi.org/https://doi.org/10.1016/j.jmp.2020.102368</a>.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
